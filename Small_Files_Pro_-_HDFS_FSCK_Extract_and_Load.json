{"paragraphs":[{"title":"Script bash shell para execução do hdfs fsck e criação do arquivo no formato csv","text":"%sh\n#!/bin/bash\n\nexport HADOOP_OPTS=\"-XX:-UseGCOverheadLimit $HADOOP_OPTS\"\nexport HADOOP_CLIENT_OPTS=\"-Xmx20480m $HADOOP_CLIENT_OPTS\"\nexport DAY=$(date +\"%Y-%m-%d\")\nexport TIME=$(date +\"%H%M%S\")\nexport DATE=$(date)\nexport USR=$(whoami)\n\nTMPDIR=/tmp/chksmallfiles\ntest -d $TMPDIR || echo \"Directory does not exists and will be created.\"; mkdir $TMPDIR\n\nhdfs_path_to_raw=/tmp/raw_fsck_extract\nhdfs_path_to_final=/tmp/final_fsck_extract\n\nLOGDIR=/var/log/smallfiles\ntest -d $LOGDIR || echo \"Directory does not exists and will be created.\"; sudo mkdir $LOGDIR; sudo chown $USR:supergroup -R $LOGDIR; sudo chmod 755 $LOGDIR\nOUTFILE=$LOGDIR/fsck_report_\"$DAY\"_$TIME.log\n\necho 'Starting fsck run for '$DAY' at '$DATE | tee $OUTFILE\necho | tee -a $OUTFILE\nFSCKRAW=$TMPDIR/fsck_raw_\"$DAY\"_$TIME.out\nhdfs fsck / -files -blocks -locations > $FSCKRAW\n\necho 'Creating blocks and files report at '$DATE | tee $OUTFILE\necho | tee -a $OUTFILE\nALLBLKFILES=$TMPDIR/all_block_files.out\ngrep \"block(s):  OK\" $FSCKRAW > $ALLBLKFILES\nsed -i 's/,/\\//g' $ALLBLKFILES\n\n# Select path, size-bytes, nro-blocks, status, extract_date\necho 'Creating csv file at '$DATE | tee $OUTFILE\necho | tee -a $OUTFILE\nCSVFILE=$TMPDIR/fsck_allBlockFiles_\"$DAY\"_$TIME.csv\nawk '{print $1\",\" $2\",\" $6\",\" $8\",\"}' $ALLBLKFILES > $CSVFILE\nsed -i \"s|$|$TIME,$DAY|g\" $CSVFILE\nsed -i \"s| ||g\" $CSVFILE\n\necho 'Uploading files to HDFS at '$DATE | tee $OUTFILE\necho | tee -a $OUTFILE\n## Security setting for supergroup access\n\nif $(hdfs dfs -test -d $hdfs_path_to_raw) ;\n\tthen\n\thdfs dfs -chmod 775 $hdfs_path_to_raw\n\thdfs dfs -put $FSCKRAW $hdfs_path_to_raw\nelse\n \thdfs dfs -mkdir -p $hdfs_path_to_raw | tee -a $OUTFILE 2>&1\n \thdfs dfs -put $FSCKRAW $hdfs_path_to_raw | tee -a $OUTFILE 2>&1\nfi\n\nif $(hdfs dfs -test -d $hdfs_path_to_final) ;\n\tthen\n\thdfs dfs -chmod 775 $hdfs_path_to_final\n\thdfs dfs -put $CSVFILE $hdfs_path_to_final\nelse\n \thdfs dfs -mkdir -p $hdfs_path_to_final | tee -a $OUTFILE 2>&1\n \thdfs dfs -put $CSVFILE $hdfs_path_to_final | tee -a $OUTFILE 2>&1\nfi\necho | tee -a $OUTFILE 2>&1\necho \"Checking errors:\"  | tee -a $OUTFILE 2>&1\ngrep 'denied/|FAILED' $FSCKRAW | tee -a $OUTFILE 2>&1\necho | tee -a $OUTFILE 2>&1\necho \"The temporary files will be deleted.\" | tee -a $OUTFILE 2>&1\nrm -rfv $TMPDIR | tee -a $OUTFILE 2>&1\nfind $LOGDIR -type f -mtime +30 -delete","user":"admin","dateUpdated":"2022-12-29T17:41:36+0000","config":{"editorSetting":{"language":"sh","editOnDblClick":false,"completionKey":"TAB","completionSupport":false},"colWidth":12,"editorMode":"ace/mode/sh","fontSize":9,"results":{},"enabled":true,"title":true},"settings":{"params":{"OUTFILE":""},"forms":{"OUTFILE":{"type":"TextBox","name":"OUTFILE","defaultValue":"","hidden":false,"$$hashKey":"object:2427"}}},"results":{"code":"SUCCESS","msg":[{"type":"TEXT","data":"mkdir: cannot create directory ‘/tmp/chksmallfiles’Directory does not exists and will be created.\n: File exists\nStarting fsck run for 2022-12-29 at Thu Dec 29 17:38:54 UTC 2022\n\nConnecting to namenode via http://cdp.18.224.174.227.nip.io:9870/fsck?ugi=centos&files=1&blocks=1&locations=1&path=%2F\nCreating blocks and files report at Thu Dec 29 17:38:54 UTC 2022\n\nCreating csv file at Thu Dec 29 17:38:54 UTC 2022\n\nUploading files to HDFS at Thu Dec 29 17:38:54 UTC 2022\n\n\nChecking errors:\n\nThe temporary files will be deleted.\nremoved ‘/tmp/chksmallfiles/fsck_raw_2022-12-29.out’\nremoved ‘/tmp/chksmallfiles/all_block_files.out’\nremoved ‘/tmp/chksmallfiles/fsck_allBlockFiles_171712.csv’\nremoved ‘/tmp/chksmallfiles/fsck_allBlockFiles_171936.csv’\nremoved ‘/tmp/chksmallfiles/fsck_raw_172342.out’\nremoved ‘/tmp/chksmallfiles/fsck_allBlockFiles_172342.csv’\nremoved ‘/tmp/chksmallfiles/fsck_raw_172400.out’\nremoved ‘/tmp/chksmallfiles/fsck_allBlockFiles_172400.csv’\nremoved ‘/tmp/chksmallfiles/fsck_runlog_172547.txt’\nremoved ‘/tmp/chksmallfiles/fsck_raw_172547.out’\nremoved ‘/tmp/chksmallfiles/fsck_allBlockFiles_2022-12-29.csv’\nremoved ‘/tmp/chksmallfiles/fsck_runlog_172626.txt’\nremoved ‘/tmp/chksmallfiles/fsck_raw_172626.out’\nremoved ‘/tmp/chksmallfiles/fsck_allBlockFiles_172626.csv’\nremoved ‘/tmp/chksmallfiles/fsck_runlog_172648.txt’\nremoved ‘/tmp/chksmallfiles/fsck_raw_172648.out’\nremoved ‘/tmp/chksmallfiles/fsck_runlog_172714.txt’\nremoved ‘/tmp/chksmallfiles/fsck_raw_172714.out’\nremoved ‘/tmp/chksmallfiles/fsck_allBlockFiles_172714_2022-12-29.csv’\nremoved ‘/tmp/chksmallfiles/fsck_runlog_172748.txt’\nremoved ‘/tmp/chksmallfiles/fsck_raw_172748.out’\nremoved ‘/tmp/chksmallfiles/fsck_allBlockFiles_2022-12-29_172748.csv’\nremoved ‘/tmp/chksmallfiles/fsck_raw_173854.out’\nremoved ‘/tmp/chksmallfiles/fsck_allBlockFiles_2022-12-29_173854.csv’\nremoved directory: ‘/tmp/chksmallfiles’\n"}]},"apps":[],"jobName":"paragraph_1671561401375_1508963048","id":"20221215-224249_1305186907","dateCreated":"2022-12-20T18:36:41+0000","dateStarted":"2022-12-29T17:38:54+0000","dateFinished":"2022-12-29T17:39:09+0000","status":"FINISHED","progressUpdateIntervalMs":500,"focus":true,"$$hashKey":"object:1631"}],"name":"Small Files/Pro - HDFS FSCK Extract and Load","id":"2HMYSSAD5","noteParams":{},"noteForms":{},"angularObjects":{"sh:admin:":[],"livy:shared_process":[]},"config":{"isZeppelinNotebookCronEnable":true,"looknfeel":"default","personalizedMode":"false","cronExecutingUser":"admin","cronExecutingRoles":"[]","cron":"0 0 0 * * ?"},"info":{}}